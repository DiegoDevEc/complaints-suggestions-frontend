<div class="complaints-page">
    <div class="page-header">
        <div class="page-title">
            <h2>Sugerencias</h2>
            <p>Administra los casos recibidos y da seguimiento a su estado.</p>
        </div>
        <p-iconfield class="search-field">
            <p-inputicon styleClass="pi pi-search" />
            <input pInputText type="text" placeholder="Buscar por nombre, estado o detalle"
                [value]="searchTerm()" (input)="onSearch($event)" />
        </p-iconfield>
    </div>

    <div class="results-summary">
        <span>Mostrando {{ filteredComplaints().length }} de {{ totalRecords }} registros</span>
    </div>

    <ng-container *ngIf="filteredComplaints().length; else emptyState">
        <div class="complaints-grid">
            <article class="complaint-card" *ngFor="let complaint of filteredComplaints(); trackBy: trackById">
                <div class="card-media" [class.clickable]="getAttachmentUrl(complaint)"
                    (click)="openImageDialog(complaint)">
                    <ng-container *ngIf="getAttachmentUrl(complaint) as imageUrl; else noImage">
                        <img [src]="imageUrl" alt="Evidencia adjunta" />
                    </ng-container>
                    <ng-template #noImage>
                        <p-avatar icon="pi pi-image" shape="circle" styleClass="placeholder-avatar" />
                    </ng-template>
                </div>

                <div class="card-body">
                    <div class="card-heading">
                        <div class="card-heading-info">
                            <h3> {{complaint.caseNumber}} </h3>
                            <span> {{ complaint.firstName }} {{ complaint.lastName }}</span>
                            <span class="type-chip" [ngClass]="getTypeClass(complaint.type)">
                                {{ getTypeDescription(complaint.type) }}
                            </span>
                        </div>
                        <p-tag [value]="getDescriptionStatus(complaint.status)"
                            [severity]="getSeverity(complaint.status)" />
                    </div>

                    <p class="card-description">
                        {{ getShortDescription(complaint.description) }}
                    </p>

                    <div class="card-meta">
                        <div class="meta-item">
                            <i class="pi pi-envelope"></i>
                            <span>{{ complaint.email || 'Sin correo registrado' }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="pi pi-phone"></i>
                            <span>{{ complaint.phone || 'Sin teléfono registrado' }}</span>
                        </div>
                        <div class="meta-item">
                            <i class="pi pi-calendar"></i>
                            <span>{{ formatDate(complaint.dateRegister) }}</span>
                        </div>
                    </div>

                    <div class="company-info">
                        <span class="company-info__label">Empresa asignada</span>
                        <ng-container *ngIf="complaint.company; else noAssignedCompany">
                            <span class="company-info__name">{{ complaint.company.name }}</span>
                            <p class="company-info__description">
                                {{ complaint.company.description || 'Sin descripción disponible.' }}
                            </p>
                        </ng-container>
                        <ng-template #noAssignedCompany>
                            <span class="company-info__empty">Sin empresa asignada</span>
                        </ng-template>
                    </div>
                </div>

                <div class="card-actions">
                    <p-button  icon="pi pi-briefcase" [outlined]="true"
                        class="action-button" (click)="openAssignCompanyDialog(complaint)" />
                    <p-button  icon="pi pi-eye" severity="info" [outlined]="true" class="action-button"
                        (click)="viewComplaints(complaint)" />
                    <p-button  icon="pi pi-pencil" [outlined]="true" class="action-button"
                        (click)="editComplaints(complaint)" />
                    <p-button icon="pi pi-trash" severity="danger" [outlined]="true"
                        class="action-button" (click)="cancelFeedback(complaint)" />
                </div>
            </article>
        </div>
    </ng-container>

    <ng-template #emptyState>
        <div class="empty-state">
            <i class="pi pi-inbox"></i>
            <p>No se encontraron denuncias para mostrar.</p>
        </div>
    </ng-template>

    <p-paginator *ngIf="totalRecords > rowsPerPageOptions[0]" [first]="first" [rows]="rows"
        [totalRecords]="totalRecords" [rowsPerPageOptions]="rowsPerPageOptions" (onPageChange)="onPageChange($event)" />
</div>

<p-dialog [(visible)]="viewDialogVisible" [style]="{ width: '520px' }" header="Detalle de la Queja" [modal]="true"
    (onHide)="closeViewDialog()">
    <ng-template #content>
        <div *ngIf="viewFeedback as complaint" class="view-dialog">
            <div class="view-dialog__status">
                <p-tag [value]="getDescriptionStatus(complaint.status)"
                    [severity]="getSeverity(complaint.status)" />
                <span class="type-chip" [ngClass]="getTypeClass(complaint.type)">
                    {{ getTypeDescription(complaint.type) }}
                </span>
            </div>

            <div class="view-dialog__grid">
                <div class="view-dialog__item">
                    <span class="label">Denunciante</span>
                    <span class="value">{{ complaint.firstName }} {{ complaint.lastName }}</span>
                </div>
                <div class="view-dialog__item">
                    <span class="label">Correo</span>
                    <span class="value">{{ complaint.email || 'Sin correo registrado' }}</span>
                </div>
                <div class="view-dialog__item">
                    <span class="label">Teléfono</span>
                    <span class="value">{{ complaint.phone || 'Sin teléfono registrado' }}</span>
                </div>
                <div class="view-dialog__item">
                    <span class="label">Fecha de registro</span>
                    <span class="value">{{ formatDate(complaint.dateRegister) }}</span>
                </div>
            </div>

            <div class="view-dialog__description">
                <span class="label">Descripción</span>
                <p>{{ complaint.description || 'Sin descripción proporcionada.' }}</p>
            </div>

            <div class="view-dialog__company">
                <span class="label">Empresa asignada</span>
                <ng-container *ngIf="complaint.company; else noCompanyView">
                    <span class="value">{{ complaint.company.name }}</span>
                    <p>{{ complaint.company.description || 'Sin descripción disponible.' }}</p>
                </ng-container>
                <ng-template #noCompanyView>
                    <span class="value view-dialog__company-empty">Sin empresa asignada</span>
                </ng-template>
            </div>

            <div class="view-dialog__attachment" *ngIf="getAttachmentUrl(complaint) as imageUrl">
                <span class="label">Adjunto</span>
                <div class="attachment-preview" (click)="openImageDialog(complaint)">
                    <img [src]="imageUrl" alt="Adjunto de la denuncia" />
                    <span>Ver imagen</span>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Cerrar" icon="pi pi-times" text (click)="closeViewDialog()" />
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="assignCompanyDialog" [style]="{ width: '540px' }" header="Asignar empresa"
    [modal]="true" (onHide)="closeAssignCompanyDialog()">
    <ng-template #content>
        <div class="assign-dialog" *ngIf="assigningFeedback as target">
            <div class="assign-dialog__header">
                <span class="assign-dialog__case">Caso {{ target.caseNumber }}</span>
                <span class="assign-dialog__reporter">{{ target.firstName }} {{ target.lastName }}</span>
            </div>

            <div class="assign-dialog__section">
                <h4>Seleccionar empresa existente</h4>
                <p>Elige una empresa registrada para vincularla con el caso.</p>

                <p-select [(ngModel)]="selectedCompanyId" [options]="companyOptions()" optionLabel="label"
                    optionValue="value" placeholder="Seleccione una empresa" class="w-full"
                    [disabled]="isLoadingCompanies">
                </p-select>

                <div class="assign-dialog__helper" *ngIf="isLoadingCompanies">
                    <i class="pi pi-spinner pi-spin"></i>
                    <span>Cargando empresas...</span>
                </div>

                <ng-container *ngIf="!isLoadingCompanies && !companyOptions().length">
                    <div class="assign-dialog__helper assign-dialog__helper--empty">
                        <i class="pi pi-briefcase"></i>
                        <span>No hay empresas registradas.</span>
                    </div>
                </ng-container>

                <ng-container *ngIf="getSelectedCompany() as selectedCompany">
                    <div class="assign-dialog__company-preview">
                        <span class="assign-dialog__company-name">{{ selectedCompany.name }}</span>
                        <p class="assign-dialog__company-description">
                            {{ selectedCompany.description || 'Sin descripción disponible.' }}
                        </p>
                    </div>
                </ng-container>

                <p-button label="Asignar empresa" icon="pi pi-check" class="assign-dialog__action"
                    (click)="assignSelectedCompany()" [disabled]="!selectedCompanyId || isAssigningCompany"
                    [loading]="isAssigningCompany" />
            </div>


        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Cerrar" icon="pi pi-times" text (click)="closeAssignCompanyDialog()" />
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="complaintsDialog" [style]="{ width: '450px' }" header="Actualizar estado" [modal]="true">
    <ng-template #content>
        <div class="flex flex-col gap-6">
            <div>
                <label for="status" class="block font-bold mb-3">Estado</label>
                <p-select inputId="status" [(ngModel)]="feedback.status" [options]="statuses" optionLabel="label"
                    optionValue="value" placeholder="Seleccione" class="w-full" />
            </div>
            <div>
                <label for="name" class="block font-bold mb-3">Denunciante</label>
                <input type="text" pInputText id="name" [(ngModel)]="feedback.firstName" required autofocus fluid
                    readonly />
            </div>
            <div>
                <label for="description" class="block font-bold mb-3">Descripción</label>
                <textarea id="description" pTextarea [(ngModel)]="feedback.description" required rows="3" cols="20"
                    fluid readonly></textarea>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
        <p-button label="Guardar" icon="pi pi-check" (click)="saveFeedback()" />
    </ng-template>
</p-dialog>

<p-confirmdialog [style]="{ width: '550px' }" />
